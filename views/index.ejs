<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Greeting Card Website</title>
  <link rel="stylesheet" href="/css/style.css"> <link rel="stylesheet" href="/css/button.css">
</head>
<body>
  <div id="container">
    <h1>&bull; Create Card &bull;</h1>
    <div class="underline"></div>
    
    <form id="greetingForm" action="/create-card" method="POST" enctype="multipart/form-data">
      <!-- Sender's Name -->
      <div class="name">
        <label for="senderName"></label>
        <input type="text" placeholder="Sender's Name" name="senderName" id="senderName" required>
      </div>
  
      <!-- Sender's Country -->
      <div class="email">
        <label for="senderCountry"></label>
        <input type="text" placeholder="Sender's Country" name="senderCountry" id="senderCountry" required>
      </div>
  
      <!-- Receiver's Name -->
      <div class="name">
        <label for="receiverName"></label>
        <input type="text" placeholder="Receiver's Name" name="receiverName" id="receiverName" required>
      </div>
  
      <!-- Receiver's Country -->
      <div class="email">
        <label for="receiverCountry"></label>
        <input type="text" placeholder="Receiver's Country" name="receiverCountry" id="receiverCountry" required>
      </div>
  
      <!-- Delivery Date and Time -->
      <div class="name">
        <label for="deliveryDate"></label>
        <input type="datetime-local" name="deliveryDate" id="deliveryDate" required>
      </div>
  
      <!-- Message -->
      <div class="message">
        <label for="message"></label>
        <textarea name="message" placeholder="Write your message" id="message" required maxlength="500"></textarea>
        <div class="character-count">0/500 characters</div>
      </div>
  
      <!-- Select Theme -->
      <div class="name">
        <label for="theme"></label>
        <select id="theme" name="theme" size="1" required>
          <option value="default">Default</option>
          <optgroup label="Celebrations">
            <option value="christmas">Christmas</option>
            <option value="newyear">New Year</option>
            <option value="graduation">Graduation</option>
            <option value="engagement">Engagement</option>
            <option value="anniversary">Wedding Anniversary</option>
            <option value="birthday">Birthday</option>
            <option value="retirement">Retirement</option>
          </optgroup>
          <optgroup label="Emotions">
            <option value="lover">Lover</option>
            <option value="love">Love</option>
            <option value="sorry">Sorry</option>
            <option value="thankyou">Thank You</option>
            <option value="getwell">Get Well Soon</option>
            <option value="congratulations">Congratulations</option>
            <option value="goodluck">Good Luck</option>
          </optgroup>
          <optgroup label="Other">
            <option value="backtoschool">Back To School</option>
          </optgroup>
        </select>
      </div>
  
      <!-- Background Song Search -->
      <div class="name">
        <label for="songSearch"></label>
        <input type="text" id="songSearch" placeholder="Search for a song">
        <div id="songResults"></div>
        <input type="hidden" id="selectedSong" name="selectedSong">
      </div>
  
      <!-- Image Upload -->
      <div class="name">
        <label for="image"></label>
        <input type="file" id="image" name="image" accept="image/*">
      </div>
  
      <!-- Voice Note Upload -->
      <div class="audio-recording">
        <button type="button" id="recordButton" class="record-button">
          Record Audio Message (Max 15s)
        </button>
        <div id="recordingStatus"></div>
        <audio id="audioPreview" controls style="display: none;"></audio>
        <input type="hidden" name="audioBlob" id="audioBlob">
      </div>

      <!-- Add video upload -->
<div class="video-upload">
  <label for="video"></label>
  <input type="file" id="video" name="video" accept="video/*">
  <div id="videoPreview"></div>
</div>
  
      <!-- Submit Button -->
      <div class="submit" style="text-align: center;">
        <button type="submit" id="form_button">SUBMIT</button>
      </div>
    </form>
  </div>
  

  <script>
    // Song Search Script
    const songSearch = document.getElementById('songSearch');
    const songResults = document.getElementById('songResults');
    const selectedSong = document.getElementById('selectedSong');
  
    songSearch.addEventListener('input', async (e) => {
      const query = e.target.value;
      if (query.length > 2) {
        const response = await fetch(`/search-song?query=${encodeURIComponent(query)}`);
        const data = await response.json();
        displaySongResults(data.results.trackmatches.track);
      }
    });
  
    function displaySongResults(tracks) {
      songResults.innerHTML = '';
      tracks.forEach(track => {
        const div = document.createElement('div');
        div.classList.add('song-item');
        div.textContent = `${track.name} - ${track.artist}`;
        div.addEventListener('click', () => {
          selectedSong.value = JSON.stringify(track);
          songSearch.value = `${track.name} - ${track.artist}`;
          songResults.innerHTML = '';
        });
        songResults.appendChild(div);
      });
    }
  </script>
  <script>
    // Character count
    const messageTextarea = document.getElementById('message');
    const charCount = document.querySelector('.character-count');
  
    messageTextarea.addEventListener('input', function() {
      const length = this.value.length;
      charCount.textContent = `${length}/500 characters`;
    });
  
    // Audio Recording
    let mediaRecorder;
    let audioChunks = [];
    let recordingTimer;
    const recordButton = document.getElementById('recordButton');
    const recordingStatus = document.getElementById('recordingStatus');
    const audioPreview = document.getElementById('audioPreview');
    const audioBlobInput = document.getElementById('audioBlob');
  
    recordButton.addEventListener('click', async () => {
      if (mediaRecorder && mediaRecorder.state === 'recording') {
        stopRecording();
      } else {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          startRecording(stream);
        } catch (err) {
          console.error('Error accessing microphone:', err);
          alert('Unable to access microphone');
        }
      }
    });
  
    function startRecording(stream) {
      audioChunks = [];
      mediaRecorder = new MediaRecorder(stream);
      
      mediaRecorder.ondataavailable = (event) => {
        audioChunks.push(event.data);
      };
  
      mediaRecorder.onstop = () => {
        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
        const audioUrl = URL.createObjectURL(audioBlob);
        audioPreview.src = audioUrl;
        audioPreview.style.display = 'block';
        
        // Convert blob to base64 for form submission
        const reader = new FileReader();
        reader.readAsDataURL(audioBlob);
        reader.onloadend = () => {
          audioBlobInput.value = reader.result;
        };
      };
  
      let seconds = 15;
      recordingStatus.textContent = `Recording: ${seconds}s remaining`;
      
      recordingTimer = setInterval(() => {
        seconds--;
        recordingStatus.textContent = `Recording: ${seconds}s remaining`;
        if (seconds <= 0) {
          stopRecording();
        }
      }, 1000);
  
      mediaRecorder.start();
      recordButton.textContent = 'Stop Recording';
    }
  
    function stopRecording() {
      mediaRecorder.stop();
      clearInterval(recordingTimer);
      recordButton.textContent = 'Record Audio Message (Max 15s)';
      recordingStatus.textContent = '';
      mediaRecorder.stream.getTracks().forEach(track => track.stop());
    }
  
    // Video Upload Preview
    const videoInput = document.getElementById('video');
    const videoPreview = document.getElementById('videoPreview');
  
    videoInput.addEventListener('change', function(e) {
      const file = this.files[0];
      if (file) {
        // Check file size (50MB limit)
        if (file.size > 50 * 1024 * 1024) {
          alert('Video must be under 50MB');
          this.value = '';
          return;
        }
  
        // Check video duration
        const video = document.createElement('video');
        video.preload = 'metadata';
  
        video.onloadedmetadata = function() {
          window.URL.revokeObjectURL(video.src);
          if (video.duration > 10) {
            alert('Video must be 10 seconds or less');
            videoInput.value = '';
            videoPreview.innerHTML = '';
          }
        };
  
        video.src = URL.createObjectURL(file);
  
        // Show preview
        videoPreview.innerHTML = `
          <video controls style="max-width: 100%; margin-top: 10px;">
            <source src="${URL.createObjectURL(file)}" type="${file.type}">
          </video>
        `;
      }
    });
  </script>
  <script src="/js/main.js"></script>
</body>
</html>